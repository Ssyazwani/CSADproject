<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Booking Dashboard</title>
<style>

  body{
    font-family: Arial, Helvetica, sans-serif;
    background-color: #b1cce8;
  }

  table {
     border-collapse: collapse;
     width: 100%;
     margin-top: 20px; 
    }

  th, td {
     border: 1px solid #444;
     padding: 5px; 
     text-align: center; 
     background-color: #f2f2f2;
  }

  th {
     background-color: #f2f2f2;
     font-size: 12px; 
     background-color: #7dafce;
  }
  .slot { 
    cursor: pointer;
    min-width: 60px;
    font-size: 12px; 
  }
  
  .slot.booked { 
    background-color: #f44336;
    color: white; 
  }

  .slot.selected { 
    background-color: #4caf50;
    color: white; 
  }

  .date-row td { 
    background-color: #99b0d7;
    font-weight: bold;
    text-align: left; 
  }

 
    header {
      display: flex;
      gap: 50px;
      padding: 10px;
      margin: 3px 0;
      margin-right: 50px 0;
      box-sizing: border-box;
      background-color: #cfecf7;
    }
  
    header a {
            margin-right: 30px;   /* space between links */
            font-weight: bold;
    }
</style>
</head>
<body>
<h1>Admin Booking Dashboard</h1>

<a href="/logout"><button>Logout</button></a>

<div>
  <label>Facility:
    <select id="serviceFacility">
      <option value="">--Select Facility--</option>
      <option value="Tennis Court">Tennis Court</option>
      <option value="Basketball Court">Basketball Court</option>
      <option value="Futsal Court">Futsal Court</option>
      <option value="Badminton Court">Badminton Court</option>
    </select>
  </label>

  <label>Start Date: <input type="date" id="startDate"></label>
  <label><input type="checkbox" id="weeklyView" checked> Weekly View</label>
  <button onclick="loadBookings()">Load Bookings</button>
</div>

<table id="bookingTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script>

  function formatDate(dateStr) {
  const d = new Date(dateStr);
  return d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
}

const slotsPerDay = [
  "09:00-10:00","10:00-11:00","11:00-12:00","12:00-13:00",
  "13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00",
  "17:00-18:00","18:00-19:00","19:00-20:00","20:00-21:00"
];

const courts = 4;

// for weekly view
function getWeekDates(start) {
  const dates = [];
  const d = new Date(start);
  for (let i = 0; i < 7; i++) {
    const dd = new Date(d);
    dd.setDate(d.getDate() + i);
    dates.push(dd.toISOString().split("T")[0]);
  }
  return dates;
}

function formatDateDDMMYYYY(dateStr) {
  const d = new Date(dateStr);
  const day = String(d.getDate()).padStart(2, '0');   // 08
  const month = String(d.getMonth() + 1).padStart(2, '0'); // 02
  const year = d.getFullYear(); // 2026
  return `${day}-${month}-${year}`;
}


async function loadBookings() {
  const facility = document.getElementById("serviceFacility").value;
  const startDate = document.getElementById("startDate").value;
  const weekly = document.getElementById("weeklyView").checked;

  const dates = weekly ? getWeekDates(startDate) : [startDate];

  const res = await fetch(`/api/admin-bookings?startDate=${dates[0]}&endDate=${dates[dates.length-1]}`);
  const bookings = await res.json();

  const table = document.getElementById("bookingTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  const headerRow = document.createElement("tr");
  headerRow.innerHTML = "<th>Court</th>";
  slotsPerDay.forEach(slot => headerRow.innerHTML += `<th>${slot}</th>`);
  thead.appendChild(headerRow);

  
  dates.forEach(date => {
    const dateRow = document.createElement("tr");
    dateRow.classList.add("date-row");
    dateRow.innerHTML = `<td colspan="${slotsPerDay.length+1}">${formatDateDDMMYYYY(date)}</td>`;

    tbody.appendChild(dateRow);

    for (let c = 1; c <= courts; c++) {
      const tr = document.createElement("tr");
      let rowHTML = `<td>Court ${c}</td>`;
      slotsPerDay.forEach(slot => {
        rowHTML += `<td class="slot" data-date="${date}" data-court="Court ${c}" data-time="${slot}"></td>`;
      });
      tr.innerHTML = rowHTML;
      tbody.appendChild(tr);
    }
  });

 
  bookings.forEach(b => {
    if (b.facility !== facility) return;
    const bookingDate = b.date.split("T")[0];
    const cell = tbody.querySelector(`.slot[data-date="${bookingDate}"][data-court="${b.court}"][data-time="${b.timeSlot}"]`);
    if (cell) {
      cell.classList.add("booked");
      cell.textContent = b.email;
      cell.dataset.bookingId = b.id;
    }
  });

 
  tbody.querySelectorAll(".slot").forEach(slot => {
    slot.onclick = async () => {
      if (!slot.dataset.bookingId) {
        const email = prompt("User email?");
        if (!email) return;
        const resUsers = await fetch("/api/users");
        const users = await resUsers.json();
        const user = users.find(u => u.email === email);
        if (!user) return alert("User not found");

        const response = await fetch("/api/admin-create-booking", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            userId: user.id,
            facility,
            date: slot.dataset.date,
            court: slot.dataset.court,
            timeSlot: slot.dataset.time
          })
        });
        const data = await response.json();
        alert(data.message);
        loadBookings();
      } else {
        const action = prompt("Type 'edit' or 'delete'");
        if (action === "delete") {
          const response = await fetch("/api/admin-delete-booking", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({bookingId: slot.dataset.bookingId})
          });
          const data = await response.json();
          alert(data.message);
          loadBookings();
        } else if (action === "edit") {
          const newDate = prompt("New date:", slot.dataset.date);
          const newTime = prompt("New time slot:", slot.dataset.time);
          const newCourt = prompt("New court:", slot.dataset.court);
          const response = await fetch("/api/admin-update-booking", {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
              bookingId: slot.dataset.bookingId,
              facility,
              date: newDate,
              court: newCourt,
              timeSlot: newTime
            })
          });
          const data = await response.json();
          alert(data.message);
          loadBookings();
        }
      }
    };
  });
}


window.addEventListener("DOMContentLoaded", loadBookings);
</script>
</body>
</html>
