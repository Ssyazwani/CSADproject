<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Booking Dashboard</title>
<style>
  table { border-collapse: collapse; width: 100%; margin-top: 20px; }
  th, td { border: 1px solid #444; padding: 5px; text-align: center; }
  th { background-color: #f2f2f2; font-size: 12px; }
  .slot { cursor: pointer; min-width: 60px; font-size: 12px; }
  .slot.booked { background-color: #f44336; color: white; }
  .slot.selected { background-color: #4caf50; color: white; }
</style>
</head>
<body>
<h1>Admin Booking Dashboard</h1>

<div>
  <label>Facility:
    <select id="serviceFacility">
      <option value="">--Select Facility--</option>
      <option value="Tennis Court">Tennis Court</option>
      <option value="Basketball Court">Basketball Court</option>
      <option value="Futsal Court">Futsal Court</option>
      <option value="Badminton Court">Badminton Court</option>
    </select>
  </label>

  <label>Start Date: <input type="date" id="startDate"></label>
  <label><input type="checkbox" id="weeklyView"> Weekly View</label>
  <button onclick="loadBookings()">Load Bookings</button>
</div>

<table id="bookingTable">
  <thead></thead>
  <tbody></tbody>
</table>

<script>
const slotsPerDay = [
  "09:00-10:00","10:00-11:00","11:00-12:00","12:00-13:00",
  "13:00-14:00","14:00-15:00","15:00-16:00","16:00-17:00",
  "17:00-18:00","18:00-19:00","19:00-20:00","20:00-21:00"
];

// Get 7 dates starting from a date
function getWeekDates(start) {
  const dates = [];
  const d = new Date(start);
  for (let i = 0; i < 7; i++) {
    const dd = new Date(d);
    dd.setDate(d.getDate() + i);
    dates.push(dd.toISOString().split("T")[0]);
  }
  return dates;
}

async function loadBookings() {
  const facility = document.getElementById("serviceFacility").value; // â† fixed ID
  const startDate = document.getElementById("startDate").value;
  const weekly = document.getElementById("weeklyView").checked;

  if (!facility || !startDate) return alert("Select facility and start date");

  let dates = weekly ? getWeekDates(startDate) : [startDate];
  const endDate = dates[dates.length - 1];

  const res = await fetch(`/api/admin-bookings?startDate=${startDate}&endDate=${endDate}`);
  const bookings = await res.json();

  const table = document.getElementById("bookingTable");
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  thead.innerHTML = "";
  tbody.innerHTML = "";

  // Build table header
  const dateRow = document.createElement("tr");
  dateRow.innerHTML = "<th rowspan='2'>Court / Time</th>";
  dates.forEach(date => dateRow.innerHTML += `<th colspan='${slotsPerDay.length}'>${date}</th>`);
  thead.appendChild(dateRow);

  const slotRow = document.createElement("tr");
  dates.forEach(_ => slotsPerDay.forEach(slot => slotRow.innerHTML += `<th>${slot}</th>`));
  thead.appendChild(slotRow);

  // Determine courts
  const courts = facility === "Tennis Court" ? 4 : 1;
  for (let c = 1; c <= courts; c++) {
    const tr = document.createElement("tr");
    const courtName = facility === "Tennis Court" ? "Court " + c : facility;
    tr.innerHTML = `<td>${courtName}</td>`;
    dates.forEach(date => {
      slotsPerDay.forEach(slot => {
        tr.innerHTML += `<td class="slot" data-court="${courtName}" data-date="${date}" data-time="${slot}"></td>`;
      });
    });
    tbody.appendChild(tr);
  }

  // Fill bookings
  bookings.forEach(b => {
    if (b.facility !== facility) return;
    const bookingDate = b.date.split("T")[0] || b.date.split(" ")[0];
    tbody.querySelectorAll(".slot").forEach(cell => {
      if (cell.dataset.court === b.court &&
          cell.dataset.date === bookingDate &&
          cell.dataset.time === b.timeSlot) {
        cell.classList.add("booked");
        cell.textContent = b.email;
        cell.dataset.bookingId = b.id;
      }
    });
  });

  // Click handler for admin
  tbody.querySelectorAll(".slot").forEach(slot => {
    slot.onclick = async () => {
      if (!slot.dataset.bookingId) {
        // Create booking
        const email = prompt("User email?");
        if (!email) return;
        const resUsers = await fetch("/api/users");
        const users = await resUsers.json();
        const user = users.find(u => u.email === email);
        if (!user) return alert("User not found");

        const response = await fetch("/api/admin-create-booking", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            userId: user.id,
            facility,
            date: slot.dataset.date,
            court: slot.dataset.court,
            timeSlot: slot.dataset.time
          })
        });
        const data = await response.json();
        alert(data.message);
        loadBookings();
      } else {
        // Edit or delete
        const action = prompt("Type 'edit' or 'delete'");
        if (action === "delete") {
          const response = await fetch("/api/admin-delete-booking", {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({bookingId: slot.dataset.bookingId})
          });
          const data = await response.json();
          alert(data.message);
          loadBookings();
        } else if (action === "edit") {
          const newDate = prompt("New date:", slot.dataset.date);
          const newTime = prompt("New time slot:", slot.dataset.time);
          const newCourt = prompt("New court:", slot.dataset.court);

          const response = await fetch("/api/admin-update-booking", {
            method:"POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({
              bookingId: slot.dataset.bookingId,
              service,
              date: newDate,
              court: newCourt,
              timeSlot: newTime
            })
          });
          const data = await response.json();
          alert(data.message);
          loadBookings();
        }
      }
    };
  });
}
</script>
</body>
</html>